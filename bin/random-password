#!/usr/bin/env bash

# Don't allow unset variables
set -o nounset

# Exit immediately if a pipeline returns non-zero.
set -o errexit
# Give helpful error message if that happens
trap 'echo "Aborting due to errexit on line $LINENO. Exit code: $?" >&2' ERR
# Allow the above trap be inherited by all functions in the script.
set -o errtrace

# Return value of a pipeline is the value of the last (rightmost) command to
# exit with a non-zero status, or zero if all commands in the pipeline exit
# successfully.
set -o pipefail

# Set $IFS to only newline and tab.
#
# http://www.dwheeler.com/essays/filenames-in-shell.html
IFS=$'\n\t'


###############################################################################
# Program Functions
###############################################################################

_print_help() {
  cat <<HEREDOC
Usage: $(basename "$0") [OPTIONS]

Generate a random password with special characters.

OPTIONS:
  -l, --length LENGTH    Set the output length (default: 32)
  -c, --clipboard        Copy output to clipboard (pbcopy)
  -h, --help            Show this help message

EXAMPLES:
  $(basename "$0")                    # Generate 32-character password
  $(basename "$0") -l 16              # Generate 16-character password
  $(basename "$0") -c                 # Generate password and copy to clipboard
  $(basename "$0") -l 20 -c           # Generate 20-character password and copy to clipboard

HEREDOC
}

###############################################################################
# Main
###############################################################################

_main() {
  local length=32
  local clipboard=false

  # Parse command line arguments
  while [[ $# -gt 0 ]]; do
    case "$1" in
      -l|--length)
        if [[ -z "${2:-}" ]] || [[ "$2" =~ ^- ]]; then
          echo "Error: --length requires a numeric argument" >&2
          exit 1
        fi
        length="$2"
        shift 2
        ;;
      -c|--clipboard)
        clipboard=true
        shift
        ;;
      -h|--help)
        _print_help
        exit 0
        ;;
      *)
        echo "Error: Unknown option: $1" >&2
        echo "Use -h or --help for usage information" >&2
        exit 1
        ;;
    esac
  done

  # Validate length is a positive integer
  if ! [[ "$length" =~ ^[0-9]+$ ]] || [[ "$length" -le 0 ]]; then
    echo "Error: Length must be a positive integer" >&2
    exit 1
  fi

  # Generate the random password
  # Note: We temporarily disable pipefail because head -c will close the pipe
  # early causing tr to receive SIGPIPE (exit 141), which is expected behavior
  local password
  set +o pipefail
  password=$(LC_ALL=C tr -dc 'A-Za-z0-9!#%&'\''()*+,-./:;<=>?@[\]^_{|}~' </dev/urandom | head -c "$length")
  set -o pipefail

  # Output to screen
  echo "$password"

  # Copy to clipboard if requested
  if [[ "$clipboard" == true ]]; then
    echo -n "$password" | pbcopy
    echo "Password copied to clipboard" >&2
  fi
}

# Call `_main` after everything has been defined.
_main "$@"


