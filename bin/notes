#!/bin/bash
#
# File is moved from Dropbox to home folder so the Dropbox never sees un-encrypted version

main() {
  local basename="${1}.txt"
  local cryptname="${basename}.gpg"
  local sync_dir="${HOME}/Dropbox/"
  local local_dir="${HOME}/"

  if [[ -e "${local_dir}${basename}" ]]; then
    echo "Unencrypted ${basename} already exists in ${local_dir}"
    exit 1
  fi

  if [[ -e "${local_dir}${cryptname}" ]]; then
    echo "Encrypted ${basename} already exists in ${local_dir}"
    exit 1
  fi

  if [[ -e "${sync_dir}${cryptname}" ]]; then
    # move crypt from Sync to Local
    mv "${sync_dir}${cryptname}" "${local_dir}"
    # decrypt
    gpg --output "${local_dir}${basename}" --decrypt "${local_dir}${cryptname}"
    # remove crypt
    rm "${local_dir}${cryptname}"
    # edit in vim
    vim "${local_dir}${basename}"
    # encrypt
    gpg --output "${local_dir}${cryptname}" --armor --default-recipient-self --encrypt "${local_dir}${basename}"
    # remove uncrypt
    rm "${local_dir}${basename}"
    # move crypt from Local to Sync
    mv "${local_dir}${cryptname}" "${sync_dir}"
  else
    echo "${basename} not found in ~/Dropbox/"
  fi
}

main "$@"
